## 第四部分：团队规范 - 游戏公会的行为准则

在大型公会（团队）中，没有规矩不成方圆。良好的规范能让团队协作更加顺畅。

### 4.1 Commit Message规范：记录你的冒险日志

**为什么需要规范化的提交信息？**

想象一下，你翻看游戏的冒险日志，看到的都是：

- "修改"
- "更新"
- "fix"
- "asdfasdf"

你完全不知道发生了什么。而如果日志是这样的：

- "🏆 击败火龙，获得神剑"
- "📦 收集了50个草药"
- "🐛 修复了传送门的bug"

是不是清晰多了？

**规范的Commit Message带来的好处：**

✅ **快速浏览历史**：一眼就能看出每次提交做了什么
✅ **自动生成CHANGELOG**：工具可以自动生成版本更新日志
✅ **代码审查效率高**：审查者能快速理解改动意图
✅ **问题追溯容易**：出问题时能快速定位相关提交
✅ **团队协作顺畅**：统一的规范减少沟通成本

#### 标准格式：Conventional Commits

最流行的规范是**Conventional Commits**（约定式提交）：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**结构说明：**

1. **Header（标题行）**：必须

   - `type`：提交类型（必须）
   - `scope`：影响范围（可选）
   - `subject`：简短描述（必须）
2. **Body（正文）**：可选

   - 详细描述改动内容
3. **Footer（页脚）**：可选

   - 关联Issue、Breaking Changes等

#### Type（提交类型）

| type               | 说明     | 游戏比喻      | 示例                            |
| ------------------ | -------- | ------------- | ------------------------------- |
| **feat**     | 新功能   | 🎯 完成新任务 | `feat: 添加用户注册功能`      |
| **fix**      | 修复bug  | 🐛 修复bug    | `fix: 修复登录页面崩溃问题`   |
| **docs**     | 文档变更 | 📖 更新攻略   | `docs: 更新README安装说明`    |
| **style**    | 代码格式 | 💄 装饰外观   | `style: 统一代码缩进为2空格`  |
| **refactor** | 重构代码 | 🔧 重整装备   | `refactor: 重构用户认证模块`  |
| **perf**     | 性能优化 | ⚡ 提升速度   | `perf: 优化首页查询性能`      |
| **test**     | 测试相关 | ✅ 测试验证   | `test: 添加登录功能单元测试`  |
| **build**    | 构建系统 | 🔨 构建工具   | `build: 升级webpack到5.0`     |
| **ci**       | CI配置   | 🤖 自动化     | `ci: 添加GitHub Actions配置`  |
| **chore**    | 其他杂项 | 🧹 杂务       | `chore: 更新依赖包版本`       |
| **revert**   | 回滚提交 | ⏪ 读取存档   | `revert: 回滚feat(login)提交` |

#### Scope（影响范围）

可选，表示此次修改影响的范围：

```
feat(auth): 添加双因素认证
fix(payment): 修复支付金额计算错误
docs(api): 更新API文档
perf(database): 优化查询索引
```

常见的scope示例：

- `auth`：认证模块
- `api`：API接口
- `ui`：用户界面
- `database`：数据库
- `config`：配置
- 具体的功能模块名

#### Subject（简短描述）

**规则：**

- 使用**祈使句**，现在时（"添加"而不是"添加了"）
- **首字母小写**（英文）
- **不要**加句号
- 限制在**50个字符**以内
- 简洁明了地描述做了什么

**好的例子：**

```bash
feat: 添加用户头像上传功能
fix: 修复移动端布局错位问题
docs: 更新部署文档
refactor: 简化表单验证逻辑
```

**不好的例子：**

```bash
feat: 添加了一个新的功能，用户可以上传头像了。  # 太啰嗦
修复。                                      # 太简略
Update code                                # 不清楚
feat: Fix bug                              # type不对
```

#### Body（详细描述）

可选，提供更详细的说明：

- 为什么做这个修改
- 如何解决的问题
- 和之前行为的对比

**格式：**

- 与header之间空一行
- 每行限制72个字符
- 可以分多段

**示例：**

```
feat: 添加用户搜索功能

用户反馈希望能快速找到其他用户，因此添加了搜索功能。

实现方式：
- 前端使用防抖优化输入性能
- 后端使用Elasticsearch进行全文搜索
- 支持按用户名和邮箱搜索

相比之前需要浏览用户列表，现在可以直接搜索定位。
```

#### Footer（页脚信息）

可选，用于关联Issue、说明破坏性变更等。

**1. 关联Issue：**

```
Closes #123
Fixes #456
Resolves #789
Related to #234
```

多个Issue：

```
Closes #123, #456, #789
```

**2. Breaking Changes（破坏性变更）：**

如果改动不兼容旧版本，必须说明：

```
BREAKING CHANGE: 移除了旧的API v1接口

所有客户端需要迁移到API v2：
- 旧接口：/api/v1/users
- 新接口：/api/v2/users

迁移指南：https://docs.example.com/migration
```

**3. 其他元信息：**

```
Reviewed-by: @zhangsan
Tested-by: @lisi
Co-authored-by: 张三 <zhangsan@example.com>
```

#### 完整示例

**示例1：简单的bug修复**

```
fix(login): 修复验证码刷新失败的问题

用户点击验证码图片时，偶尔无法刷新。
问题原因是缓存策略不当，现已添加时间戳参数。

Closes #234
```

**示例2：新功能**

```
feat(comments): 添加评论功能

实现了文章评论系统，包括：
- 发布评论
- 回复评论
- 删除自己的评论
- 管理员审核

评论支持Markdown格式，最大长度1000字。

Closes #456
```

**示例3：重构**

```
refactor(auth): 重构认证模块以提高可测试性

原有认证逻辑与数据库耦合过紧，难以测试。
重构后：
- 抽取了认证服务接口
- 实现了依赖注入
- 添加了mock实现用于测试

测试覆盖率从30%提升到85%。

Related to #789
```

**示例4：性能优化**

```
perf(search): 优化搜索查询性能

之前全表扫描导致搜索速度慢。

优化措施：
- 为关键字段添加索引
- 使用Redis缓存热门搜索结果
- 实现搜索结果分页加载

搜索响应时间从2s降低到100ms。

Closes #345
```

**示例5：破坏性变更**

```
feat(api)!: 升级API到v2版本

升级API规范，统一响应格式和错误处理。

主要变更：
- 统一使用RESTful风格
- 响应格式统一为JSON
- 错误代码规范化

BREAKING CHANGE: 移除API v1所有接口

迁移指南：
- /api/v1/users -> /api/v2/users
- /api/v1/login -> /api/v2/auth/login
详细文档：https://docs.example.com/api-v2

Closes #567
```

#### 实用技巧

**1. 使用Git Hooks自动验证**

创建 `.git/hooks/commit-msg` 文件：

```bash
#!/bin/sh

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# 检查格式
if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"; then
    echo "错误：提交信息格式不正确！"
    echo ""
    echo "正确格式："
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo "示例："
    echo "  feat: 添加用户注册功能"
    echo "  fix(login): 修复验证码问题"
    exit 1
fi

exit 0
```

**2. 使用Commitizen工具**

安装：

```bash
npm install -g commitizen cz-conventional-changelog
```

使用：

```bash
git cz  # 代替git commit，会有交互式提示
```

**3. 修改最近一次提交信息**

```bash
git commit --amend -m "fix: 修正提交信息"
```

**4. 批量修改历史提交信息**

```bash
# 交互式rebase最近3个提交
git rebase -i HEAD~3

# 在编辑器中，将要修改的commit前的pick改为reword
# 保存后会逐个打开编辑器让你修改提交信息
```

#### 团队约定示例

建议在项目的 `CONTRIBUTING.md` 中明确规范：

```markdown
## 提交信息规范

我们使用Conventional Commits规范。

### 格式
```

`<type>`(`<scope>`): `<subject>`

```

### Type类型
- feat: 新功能
- fix: Bug修复
- docs: 文档修改
- style: 代码格式
- refactor: 代码重构
- perf: 性能优化
- test: 测试相关
- chore: 其他杂项

### 示例
```

feat(auth): 添加双因素认证
fix(login): 修复验证码刷新问题
docs: 更新API文档

```

### 关联Issue
在Footer中使用 `Closes #123` 关联Issue。
```

### 4.2 分支命名规范：给你的任务线起个好名字

清晰的分支命名能让团队成员一眼看出分支的用途。

#### 命名格式

```
<type>/<issue-number>-<short-description>
```

**组成部分：**

1. **type**：分支类型
2. **issue-number**：关联的Issue编号（如果有）
3. **short-description**：简短描述（使用kebab-case）

#### 分支类型

| 类型                    | 说明       | 示例                          |
| ----------------------- | ---------- | ----------------------------- |
| `feature/`            | 新功能开发 | `feature/user-registration` |
| `bugfix/` 或 `fix/` | Bug修复    | `fix/login-error`           |
| `hotfix/`             | 紧急修复   | `hotfix/security-patch`     |
| `release/`            | 发布分支   | `release/1.0.0`             |
| `refactor/`           | 重构       | `refactor/auth-module`      |
| `docs/`               | 文档更新   | `docs/api-documentation`    |
| `test/`               | 测试相关   | `test/unit-tests`           |
| `chore/`              | 杂项任务   | `chore/update-dependencies` |

#### 命名规则

**✅ 好的命名：**

```
feature/issue-123-user-avatar-upload
fix/issue-456-login-crash
hotfix/payment-calculation-error
release/2.0.0
refactor/database-optimization
docs/installation-guide
feature/add-search-function
```

**特点：**

- 全部小写
- 使用连字符（kebab-case）
- 包含Issue编号
- 描述清晰简洁
- 不使用特殊字符

**❌ 不好的命名：**

```
dev                           # 太模糊
feature_新功能                 # 混用下划线和中文
fix/Bug修复                   # 使用中文
feature/AddUserAvatar         # 使用驼峰命名
test1234                      # 无意义的名称
zhangsan-branch               # 使用人名
```

#### 完整示例

**场景1：开发Issue #123的用户注册功能**

```bash
git checkout -b feature/issue-123-user-registration develop
```

**场景2：修复Issue #456的登录问题**

```bash
git checkout -b fix/issue-456-login-validation develop
```

**场景3：紧急修复支付bug（没有Issue）**

```bash
git checkout -b hotfix/payment-error-fix main
```

**场景4：准备v2.0.0版本发布**

```bash
git checkout -b release/2.0.0 develop
```

**场景5：重构认证模块（Issue #789）**

```bash
git checkout -b refactor/issue-789-auth-module develop
```

#### 分支生命周期管理

**1. 及时删除已合并的分支**

```bash
# 删除本地分支
git branch -d feature/issue-123-user-registration

# 删除远程分支
git push origin --delete feature/issue-123-user-registration
```

**2. 定期清理远程已删除的分支引用**

```bash
git fetch --prune
```

**3. 查看分支状态**

```bash
# 查看已合并到main的分支
git branch --merged main

# 查看未合并的分支
git branch --no-merged main
```

#### 特殊情况处理

**1. 长期功能分支**

对于需要长期开发的大功能：

```
feature/epic-123-payment-system
feature/epic-123-payment-gateway
feature/epic-123-payment-ui
```

**2. 实验性分支**

尝试新想法：

```
experiment/new-architecture
spike/performance-test
```

**3. 个人分支**

在自己的命名空间下：

```
zhangsan/feature/try-new-feature
zhangsan/experiment/test-idea
```

### 4.3 PR描述规范：任务提交报告模板

良好的PR描述能让审查者快速理解你的改动。

#### PR标题规范

与Commit Message保持一致：

```
<type>: <description> (#issue-number)
```

**示例：**

```
feat: 添加用户注册功能 (#123)
fix: 修复登录页面崩溃问题 (#456)
refactor: 重构认证模块 (#789)
```

#### PR描述模板

创建 `.github/PULL_REQUEST_TEMPLATE.md`（或Gitea对应位置）：

```markdown
## 相关Issue
<!-- 关联的Issue，使用Closes #123自动关闭 -->
Closes #

## 改动类型
<!-- 请勾选相关选项 -->
- [ ] 新功能 (feature)
- [ ] Bug修复 (fix)
- [ ] 重构 (refactor)
- [ ] 文档更新 (docs)
- [ ] 性能优化 (perf)
- [ ] 测试 (test)
- [ ] 构建/依赖 (build/chore)

## 改动说明
<!-- 简要描述这个PR做了什么 -->


## 具体改动
<!-- 列出主要的代码改动 -->
- 
- 
- 

## 技术细节
<!-- 重要的技术实现细节、算法说明等 -->


## 测试情况
<!-- 勾选已完成的测试 -->
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 手动测试通过
- [ ] 性能测试通过（如果需要）

### 测试说明
<!-- 如何测试、测试覆盖率等 -->


## 截图/演示
<!-- 如果有UI改动，请附上截图或GIF -->


## 检查清单
<!-- 提交前请确认 -->
- [ ] 代码遵循项目编码规范
- [ ] 进行了自我代码审查
- [ ] 添加了必要的注释（特别是复杂逻辑）
- [ ] 更新了相关文档
- [ ] 没有新增警告
- [ ] 添加了测试用例
- [ ] 所有测试通过
- [ ] 依赖的PR已合并（如果有）

## 破坏性变更
<!-- 如果有不兼容的改动，请详细说明 -->
- [ ] 此PR包含破坏性变更

如果包含，请说明：


## 性能影响
<!-- 是否影响性能，如何影响 -->
- [ ] 无性能影响
- [ ] 性能提升
- [ ] 性能下降（需要说明原因）

## 安全考虑
<!-- 是否涉及安全问题 -->


## 后续工作
<!-- 依赖此PR的工作、计划的改进等 -->


## 需要特别注意的地方
<!-- 审查者应该重点关注的部分 -->


## 额外信息
<!-- 其他相关信息 -->

```

#### 完整PR描述示例

```markdown
## 相关Issue
Closes #200

## 改动类型
- [x] 新功能 (feature)
- [ ] Bug修复 (fix)
- [ ] 重构 (refactor)
- [ ] 文档更新 (docs)
- [ ] 性能优化 (perf)
- [ ] 测试 (test)
- [ ] 构建/依赖 (build/chore)

## 改动说明
实现用户头像上传功能，用户可以上传、裁剪和设置头像。

## 具体改动
- 前端添加头像上传组件（Vue.js）
- 实现图片裁剪和预览功能
- 后端添加文件上传API接口
- 实现图片存储和缩略图生成
- 添加文件类型和大小验证
- 更新用户模型和数据库表结构

## 技术细节
- 使用`vue-cropper`实现图片裁剪
- 图片存储使用阿里云OSS
- 服务端使用`Pillow`库生成缩略图（150x150）
- 支持的格式：JPG、PNG、GIF
- 文件大小限制：5MB
- 图片自动压缩以减少存储空间

## 测试情况
- [x] 单元测试通过（覆盖率88%）
- [x] 集成测试通过
- [x] 手动测试通过
- [x] 性能测试通过

### 测试说明
- 添加了17个单元测试用例
- 测试了文件上传、裁剪、验证等场景
- 边界测试：超大文件、非法格式、恶意文件
- 性能测试：1000次并发上传无问题

## 截图/演示
### 上传界面
![upload-ui](https://example.com/screenshot1.png)

### 裁剪功能
![crop-ui](https://example.com/screenshot2.png)

## 检查清单
- [x] 代码遵循项目编码规范
- [x] 进行了自我代码审查
- [x] 添加了必要的注释
- [x] 更新了相关文档（API文档、用户手册）
- [x] 没有新增警告
- [x] 添加了测试用例
- [x] 所有测试通过
- [x] 依赖的PR已合并（无依赖）

## 破坏性变更
- [ ] 此PR包含破坏性变更

## 性能影响
- [x] 无性能影响
- [ ] 性能提升
- [ ] 性能下降

图片处理在后台异步进行，不影响用户响应速度。

## 安全考虑
- 实现了文件类型白名单验证
- 检测文件真实类型（不仅仅依赖扩展名）
- 文件大小限制防止DoS攻击
- 上传文件名随机化，防止路径遍历
- OSS访问使用临时凭证

## 后续工作
- #201: 添加头像历史记录功能
- #202: 支持从摄像头拍照上传

## 需要特别注意的地方
- `ImageProcessor`类中的裁剪算法较为复杂，请重点review
- OSS配置信息需要在部署时正确设置环境变量

## 额外信息
- 参考了GitHub和GitLab的头像上传实现
- 设计稿：https://figma.com/xxxx
```

### 4.4 代码审查清单：审查装备的标准

为了保证代码质量，审查时应该检查以下方面。

#### 功能性检查

```markdown
## 功能性
- [ ] 功能是否符合需求描述
- [ ] 是否完整实现了Issue中的所有要求
- [ ] 边界情况是否处理（空值、极值、异常）
- [ ] 错误处理是否完善
- [ ] 用户体验是否良好
```

**示例问题：**

- 用户输入空字符串时会怎样？
- 数据库查询为空时是否正确处理？
- 网络请求失败是否有重试机制？

#### 代码质量检查

```markdown
## 代码质量
- [ ] 代码风格符合项目规范
- [ ] 变量和函数命名是否清晰易懂
- [ ] 函数是否单一职责
- [ ] 是否有重复代码（DRY原则）
- [ ] 代码复杂度是否合理
- [ ] 是否遵循SOLID原则
```

**示例问题：**

- 变量名 `data`太笼统，能否改为更具体的名字？
- 这个函数有200行，是否可以拆分？
- 这段逻辑在另一个文件也出现了，能否抽取公共方法？

#### 安全性检查

```markdown
## 安全性
- [ ] 用户输入是否经过验证和过滤
- [ ] 是否存在SQL注入风险
- [ ] 是否存在XSS攻击风险
- [ ] 敏感信息（密码、密钥）是否加密
- [ ] API接口是否有权限验证
- [ ] 是否存在CSRF风险
- [ ] 文件上传是否安全
```

**示例问题：**

- 直接拼接SQL会有注入风险，请使用参数化查询
- 用户输入直接输出到页面，需要转义HTML
- 密码明文存储，应该使用bcrypt加密

#### 性能检查

```markdown
## 性能
- [ ] 是否有N+1查询问题
- [ ] 是否有不必要的循环嵌套
- [ ] 数据库查询是否有索引
- [ ] 是否可以使用缓存
- [ ] 大数据量是否分页处理
- [ ] 资源是否及时释放
- [ ] 算法复杂度是否合理
```

**示例问题：**

- 循环中执行数据库查询，建议改为批量查询
- 这个接口每次都查询全表，建议加索引
- 计算结果可以缓存，避免重复计算

#### 测试检查

```markdown
## 测试
- [ ] 是否有足够的单元测试
- [ ] 测试覆盖率是否达标（如80%）
- [ ] 测试用例是否覆盖主要场景
- [ ] 边界情况是否有测试
- [ ] 异常情况是否有测试
- [ ] 集成测试是否通过
```

**示例问题：**

- 缺少对空值情况的测试
- 核心逻辑测试覆盖率只有40%，建议补充
- 测试用例没有验证错误情况

#### 文档检查

```markdown
## 文档
- [ ] 复杂逻辑是否有注释
- [ ] 公共API是否有文档
- [ ] README是否需要更新
- [ ] API文档是否更新
- [ ] 变更日志是否记录
```

**示例问题：**

- 这个算法比较复杂，建议添加注释说明原理
- 新增了API接口，需要更新Swagger文档
- README中的安装步骤需要更新

#### 兼容性检查

```markdown
## 兼容性
- [ ] 是否兼容支持的浏览器版本
- [ ] 是否兼容移动端
- [ ] 是否有破坏性变更
- [ ] 数据库迁移是否向后兼容
- [ ] API变更是否向后兼容
```

**示例问题：**

- 使用了ES6语法，IE11不支持，需要转译
- 删除了旧的API字段，会导致旧客户端出错

#### 依赖和配置检查

```markdown
## 依赖和配置
- [ ] 新增依赖是否必要
- [ ] 依赖版本是否合理
- [ ] 配置文件是否正确
- [ ] 环境变量是否文档化
- [ ] 是否有敏感信息硬编码
```

**示例问题：**

- 为了一个功能引入一个大型库，是否必要？
- API密钥硬编码在代码中，应该使用环境变量

#### 代码审查模板

在Gitea中创建审查模板 `.gitea/REVIEW_TEMPLATE.md`：

```markdown
## Code Review Checklist

### 功能性 ✅
- [ ] 功能完整实现
- [ ] 边界情况处理
- [ ] 错误处理完善

### 代码质量 📝
- [ ] 代码规范
- [ ] 命名清晰
- [ ] 无重复代码
- [ ] 复杂度合理

### 安全性 🔒
- [ ] 输入验证
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] 权限验证

### 性能 ⚡
- [ ] 无N+1问题
- [ ] 查询优化
- [ ] 算法效率

### 测试 ✅
- [ ] 单元测试充分
- [ ] 覆盖率达标
- [ ] 边界测试

### 文档 📚
- [ ] 注释清晰
- [ ] API文档
- [ ] README更新

---

### 总体评价
<!-- 简要评价这个PR的质量 -->

### 主要问题
<!-- 列出需要修改的重要问题 -->

### 建议优化
<!-- 可选的优化建议 -->

### 学习点
<!-- 从这个PR中学到的好的实践 -->
```

#### 审查评论示例

**好的评论：**

```markdown
👍 代码整体质量很高！

## 必须修改
1. **安全问题**：第45行直接拼接SQL，存在注入风险
   
   # 当前代码
   query = f"SELECT * FROM users WHERE id = {user_id}"
   
   # 建议改为
   query = "SELECT * FROM users WHERE id = ?"
   cursor.execute(query, (user_id,))


2. **性能问题**：第78-82行循环中查询数据库

   # 建议改为批量查询
   user_ids = [item.user_id for item in items]
   users = User.get_by_ids(user_ids)


## 建议优化
1. 函数`processUserData`命名可以改为`process_user_data`（蛇形命名）
2. 第120行的正则表达式较复杂，建议添加注释说明

## 优点
- 测试覆盖率很好，达到92%
- 错误处理完善
- 代码结构清晰
```

**不好的评论：**

```markdown
❌ 代码有问题。

# 太模糊，没有具体说明

❌ 这里写得不对，改一下。

# 没有说明为什么不对，如何改

❌ 你这样写不行。

# 语气不友好，缺乏建设性
```

#### 小结：团队规范核心要点

恭喜你学会了团队协作规范！现在你已经掌握了：

✅ **Commit Message规范**

- Conventional Commits格式
- type、scope、subject的使用
- Body和Footer的编写
- 关联Issue和说明破坏性变更

✅ **分支命名规范**

- 统一的命名格式
- 不同类型分支的命名
- 分支生命周期管理

✅ **PR描述规范**

- 清晰的PR标题
- 完整的PR描述模板
- 检查清单的使用

✅ **代码审查清单**

- 功能性、质量、安全、性能检查
- 测试和文档验证
- 建设性的审查评论

这些规范能让团队协作更加顺畅，代码质量更高。在下一部分，我们将学习一些**进阶技巧和常见问题的解决方法**，让你成为真正的Git大师！

---
